{% extends 'base.html' %}

{% block content %}
<h1>Password Manager</h1>

<div class="button-container">
  <a href="{{ url_for('add_password') }}" class="btn btn-primary">➕ Add New Password</a>
</div>

<div class="table-container">
  <table class="table">
    <thead>
      <tr>
        <th>Site</th>
        <th>Username</th>
        <th>Password</th>
        <th>Additional Fields</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for entry, username, password, additional_fields in data %}
      <tr>
        <td><strong>{{ entry.site }}</strong></td>
        <td>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="flex: 1;">{{ username }}</span>
            <button type="button" class="copy-btn" data-copy="{{ username }}" data-type="username" title="Copy username"
                    style="position: relative; background: none; border: none; padding: 0.4rem; cursor: pointer; color: #667eea; border-radius: 4px; transition: all 0.2s;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
          </div>
        </td>
        <td>
          <div class="password-input-wrapper">
            <input type="password" class="form-control password-field" value="{{ password }}" readonly>
            <button type="button" class="btn-icon-inline toggle-btn" title="Show/Hide password">
              <svg class="icon-show" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <svg class="icon-hide" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
              </svg>
            </button>
            <button type="button" class="btn-icon-inline copy-btn" data-copy="{{ password }}" data-type="password" title="Copy password">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
          </div>
        </td>
        <td>
          {% if additional_fields %}
            <button type="button" class="view-fields-btn" data-entry-id="{{ entry.id }}" style="display: inline-flex; align-items: center; gap: 0.3rem; background: #667eea; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <span>View {{ additional_fields|length }} field{{ 's' if additional_fields|length != 1 else '' }}</span>
            </button>
            <!-- Hidden fields container -->
            <div id="fields-{{ entry.id }}" class="fields-container" style="display: none; margin-top: 0.75rem;">
              {% for field in additional_fields %}
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.8rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 0.5rem;">
                  <div style="flex: 1;">
                    <div style="font-weight: 600; color: #667eea; font-size: 0.85rem; margin-bottom: 0.25rem;">{{ field.label }}</div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="password" class="field-value-display" value="{{ field.value }}" readonly style="flex: 1; border: none; background: transparent; font-family: monospace; font-size: 0.9rem; padding: 0.25rem 0;">
                      <button type="button" class="toggle-field-btn" title="Show/Hide" style="background: none; border: none; cursor: pointer; padding: 0.25rem; color: #6b7280;">
                        <svg class="icon-show-field" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                          <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <svg class="icon-hide-field" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                          <line x1="1" y1="1" x2="23" y2="23"></line>
                        </svg>
                      </button>
                      <button type="button" class="copy-btn" data-copy="{{ field.value }}" data-type="field" data-field-name="{{ field.label }}" title="Copy {{ field.label }}" style="background: none; border: none; cursor: pointer; padding: 0.25rem; color: #667eea;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <span style="color: #9ca3af; font-size: 0.9rem; font-style: italic;">None</span>
          {% endif %}
        </td>
        <td>
          <div style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
            <a href="{{ url_for('edit_password', entry_id=entry.id) }}" class="btn btn-sm btn-outline-secondary" title="Edit password" style="display: inline-flex; align-items: center; gap: 0.25rem;">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              Edit
            </a>
            <a href="#" class="delete-btn" data-entry-id="{{ entry.id }}" data-site="{{ entry.site }}" style="color: var(--danger-color); text-decoration: none; font-weight: 600; padding: 0.4rem 0.8rem; border-radius: 8px; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.25rem;">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
              Delete
            </a>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h3>Delete Password</h3>
    <p id="deleteMessage">Are you sure you want to delete this password?</p>
    <div class="modal-buttons">
      <button id="cancelDelete" class="btn btn-outline-secondary">Cancel</button>
      <button id="confirmDelete" class="btn btn-danger">Delete</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Toggle password visibility
    const toggleButtons = document.querySelectorAll('.toggle-btn');

    toggleButtons.forEach(function (btn) {
      btn.addEventListener('click', function () {
        const passwordInput = this.closest('tr').querySelector('.password-field');
        const iconShow = this.querySelector('.icon-show');
        const iconHide = this.querySelector('.icon-hide');

        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          iconShow.style.display = 'none';
          iconHide.style.display = 'block';
        } else {
          passwordInput.type = 'password';
          iconShow.style.display = 'block';
          iconHide.style.display = 'none';
        }
      });
    });

    // Toggle additional fields visibility (show/hide fields container)
    const viewFieldsButtons = document.querySelectorAll('.view-fields-btn');

    viewFieldsButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        const entryId = this.getAttribute('data-entry-id');
        const fieldsContainer = document.getElementById('fields-' + entryId);
        const buttonText = this.querySelector('span');

        if (fieldsContainer.style.display === 'none') {
          fieldsContainer.style.display = 'block';
          buttonText.textContent = 'Hide fields';
        } else {
          fieldsContainer.style.display = 'none';
          const fieldCount = fieldsContainer.querySelectorAll('.field-value-display').length;
          buttonText.textContent = 'View ' + fieldCount + ' field' + (fieldCount !== 1 ? 's' : '');
        }
      });
    });

    // Toggle individual field value visibility (show/hide like passwords)
    const toggleFieldButtons = document.querySelectorAll('.toggle-field-btn');

    toggleFieldButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        const fieldInput = this.closest('div').querySelector('.field-value-display');
        const iconShow = this.querySelector('.icon-show-field');
        const iconHide = this.querySelector('.icon-hide-field');

        if (fieldInput.type === 'password') {
          fieldInput.type = 'text';
          iconShow.style.display = 'none';
          iconHide.style.display = 'block';
        } else {
          fieldInput.type = 'password';
          iconShow.style.display = 'block';
          iconHide.style.display = 'none';
        }
      });
    });

    // Copy to clipboard functionality with custom messages
    const copyButtons = document.querySelectorAll('.copy-btn');
    const toast = document.getElementById('toast');

    copyButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        const textToCopy = this.getAttribute('data-copy');
        const copyType = this.getAttribute('data-type');
        const fieldName = this.getAttribute('data-field-name');

        // Copy to clipboard
        navigator.clipboard.writeText(textToCopy).then(function() {
          // Set custom toast message based on type
          let message = '✓ Copied to clipboard!';
          if (copyType === 'username') {
            message = '✓ Username copied!';
          } else if (copyType === 'password') {
            message = '✓ Password copied!';
          } else if (copyType === 'field' && fieldName) {
            message = `✓ ${fieldName} copied!`;
          }

          toast.textContent = message;
          toast.classList.add('show');

          // Hide toast after 2 seconds
          setTimeout(function() {
            toast.classList.remove('show');
          }, 2000);
        }).catch(function(err) {
          console.error('Failed to copy:', err);
          toast.textContent = '✗ Failed to copy';
          toast.classList.add('show');
          setTimeout(function() {
            toast.classList.remove('show');
          }, 2000);
        });
      });
    });

    // Delete functionality
    const deleteButtons = document.querySelectorAll('.delete-btn');
    const modal = document.getElementById('deleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const deleteMessage = document.getElementById('deleteMessage');
    let entryToDelete = null;

    deleteButtons.forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        entryToDelete = this.getAttribute('data-entry-id');
        const siteName = this.getAttribute('data-site');
        deleteMessage.textContent = `Are you sure you want to delete the password for ${siteName}?`;
        modal.style.display = 'flex';
      });
    });

    confirmDeleteBtn.addEventListener('click', function() {
      if (entryToDelete) {
        window.location.href = `/delete/${entryToDelete}`;
      }
    });

    cancelDeleteBtn.addEventListener('click', function() {
      modal.style.display = 'none';
      entryToDelete = null;
    });

    window.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
        entryToDelete = null;
      }
    });
  });
</script>

<style>
  /* Username copy button hover effect */
  td .copy-btn:hover {
    background: rgba(102, 126, 234, 0.1) !important;
  }

  td .copy-btn:active {
    transform: scale(0.95);
  }
</style>

{% endblock %}